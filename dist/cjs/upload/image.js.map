{"version":3,"sources":["../../../src/upload/image.ts"],"names":["ImageUpload","options","allowedTypes","quality","outputType","orientationAllowed","lessCrop","imageOptions","window","file","data","reset","isFileTypeValid","resizeAndConvert","blob","name","File","type","uploadFile","width","height","setError","minWidth","minHeight","isValid","setTimeout","error","next","complete","length","some","allowedType","maxHeight","maxWidth","exif","initialProgress","progress","image","document","createElement","onload","canvas","context","getContext","handleOrientationAllowed","isImageMinSizeValid","maxWRatio","maxHRatio","ratios","filter","ratio","Math","min","max","newWidth","newHeight","minWRatio","minHRatio","sourceWidth","sourceHeight","x","y","drawImage","metadata","value","String","lat","lon","push","blobCallback","nameSplit","split","pop","nameParts","replace","newFile","join","buildFormData","toBlob","reader","FileReader","event","result","target","urlCreator","URL","webkitURL","Data","ExifParserFactory","create","parse","tags","GPSLatitude","GPSLongitude","e","console","log","src","createObjectURL","readAsArrayBuffer","Promise","resolve","img","Image","onerror","toDataURL","match","FileUpload"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;;;;;AAyDA;AACA;AACA;AACA;AACA;IACaA,W;;;;;AAIX;AACF;AACA;AACE,uBAAYC,OAAZ,EAAyC;AAAA;;AAAA;AACvC,gCAMIA,OANJ,CACEC,YADF;AAAA,QACEA,YADF,sCACiB,CAAC,YAAD,EAAe,WAAf,CADjB;AAAA,2BAMID,OANJ,CAEEE,OAFF;AAAA,QAEEA,OAFF,iCAEY,IAFZ;AAAA,8BAMIF,OANJ,CAGEG,UAHF;AAAA,QAGEA,UAHF,oCAGe,YAHf;AAAA,gCAMIH,OANJ,CAIEI,kBAJF;AAAA,QAIEA,kBAJF,sCAIuB,IAJvB;AAAA,4BAMIJ,OANJ,CAKEK,QALF;AAAA,QAKEA,QALF,kCAKa,KALb;AAQA,8BAAML,OAAN;AATuC;AAAA;AAUvC,UAAKM,YAAL;AACEL,MAAAA,YAAY,EAAZA,YADF;AAEEC,MAAAA,OAAO,EAAPA,OAFF;AAGEC,MAAAA,UAAU,EAAVA,UAHF;AAIEC,MAAAA,kBAAkB,EAAlBA,kBAJF;AAKEC,MAAAA,QAAQ,EAARA;AALF,OAMK,MAAKL,OANV,GAOKA,OAPL;AASA,UAAKO,MAAL,GAAcA,MAAd;AAnBuC;AAoBxC;AAED;AACF;AACA;AACA;AACA;;;;;WACE,oBACEC,IADF,EAGQ;AAAA,UADNC,IACM,uEADmE,EACnE;AACN,WAAKC,KAAL;;AAEA,UAAI,CAAC,KAAKC,eAAL,CAAqBH,IAArB,CAAL,EAAiC;AAC/B;AACD;;AAED,WAAKI,gBAAL,CAAsBJ,IAAtB,EAA4BC,IAA5B;AACD;AAED;AACF;AACA;AACA;AACA;AACA;;;;WACE,oBACEI,IADF,EAEEC,IAFF,EAIQ;AAAA,UADNL,IACM,uEADmE,EACnE;AACN,UAAMD,IAAI,GAAG,IAAIO,IAAJ,CAAS,CAACF,IAAD,CAAT,EAAiBC,IAAjB,EAAuB;AAAEE,QAAAA,IAAI,EAAEH,IAAI,CAACG;AAAb,OAAvB,CAAb;AACA,WAAKC,UAAL,CAAgBT,IAAhB,EAAsBC,IAAtB;AACD;AAED;AACF;AACA;AACA;;;;;AAsBE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACE,iCACES,KADF,EAEEC,MAFF,EAIW;AAAA;;AAAA,UADTC,QACS,uEADW,IACX;;AACT,UAAI,EAAE,KAAKd,YAAL,CAAkBe,QAAlB,IAA8B,KAAKf,YAAL,CAAkBgB,SAAlD,CAAJ,EAAkE;AAChE,eAAO,IAAP;AACD;;AAED,UAAMC,OAAO,GACXL,KAAK,IAAI,KAAKZ,YAAL,CAAkBe,QAA3B,IACAF,MAAM,IAAI,KAAKb,YAAL,CAAkBgB,SAF9B;;AAIA,UAAIF,QAAQ,IAAI,CAACG,OAAjB,EAA0B;AACxBC,QAAAA,UAAU,CAAC;AAAA,iBAAM,MAAI,CAACC,KAAL,CAAWC,IAAX,CAAgB,SAAhB,CAAN;AAAA,SAAD,CAAV;AACAF,QAAAA,UAAU,CAAC;AAAA,iBAAM,MAAI,CAACG,QAAL,CAAcD,IAAd,CAAmB,IAAnB,CAAN;AAAA,SAAD,CAAV;AACD;;AAED,aAAOH,OAAP;AACD;AAED;AACF;AACA;AACA;AACA;;;;WACE,yBAA0Bf,IAA1B,EAA+C;AAAA;;AAC7C,UACE,KAAKF,YAAL,CAAkBL,YAAlB,CAAgC2B,MAAhC,GAAyC,CAAzC,IACA,CAAC,KAAKtB,YAAL,CAAkBL,YAAlB,CAAgC4B,IAAhC,CACC,UAACC,WAAD;AAAA,eAAiBA,WAAW,KAAKtB,IAAI,CAACQ,IAAtC;AAAA,OADD,CAFH,EAKE;AACAQ,QAAAA,UAAU,CAAC,YAAM;AACf,cAAMC,KAAK,GACTjB,IAAI,CAACQ,IAAL,KAAc,YAAd,GACI,uBADJ,GAEI,kBAHN;;AAIA,UAAA,MAAI,CAACS,KAAL,CAAWC,IAAX,CAAgBD,KAAhB;AACD,SANS,CAAV;AAOAD,QAAAA,UAAU,CAAC;AAAA,iBAAM,MAAI,CAACG,QAAL,CAAcD,IAAd,CAAmB,IAAnB,CAAN;AAAA,SAAD,CAAV;AACA,aAAKhB,KAAL;AACA,eAAO,KAAP;AACD;;AAED,aAAO,IAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;;;;WACE,kCAAiCQ,KAAjC,EAAgDC,MAAhD,EAAgE;AAC9D,UAAI,CAAC,KAAKb,YAAL,CAAkBF,kBAAvB,EAA2C,OADmB,CAG9D;AACA;;AACA,UAAI,KAAKE,YAAL,CAAkByB,SAAlB,IAA+B,KAAKzB,YAAL,CAAkB0B,QAArD,EAA+D;AAC7D,YAAId,KAAK,GAAGC,MAAZ,EAAoB;AAClB,cAAI,KAAKb,YAAL,CAAkByB,SAAlB,GAA8B,KAAKzB,YAAL,CAAkB0B,QAApD,EAA8D;AAAA,uBACA,CAC1D,KAAK1B,YAAL,CAAkB0B,QADwC,EAE1D,KAAK1B,YAAL,CAAkByB,SAFwC,CADA;AAC3D,iBAAKzB,YAAL,CAAkByB,SADyC;AAC9B,iBAAKzB,YAAL,CAAkB0B,QADY;AAK7D;AACF,SAPD,MAOO,IAAI,KAAK1B,YAAL,CAAkByB,SAAlB,GAA8B,KAAKzB,YAAL,CAAkB0B,QAApD,EAA8D;AAAA,sBACP,CAC1D,KAAK1B,YAAL,CAAkB0B,QADwC,EAE1D,KAAK1B,YAAL,CAAkByB,SAFwC,CADO;AAClE,eAAKzB,YAAL,CAAkByB,SADgD;AACrC,eAAKzB,YAAL,CAAkB0B,QADmB;AAKpE;AACF,OAnB6D,CAqB9D;AACA;;;AACA,UAAI,KAAK1B,YAAL,CAAkBgB,SAAlB,IAA+B,KAAKhB,YAAL,CAAkBe,QAArD,EAA+D;AAC7D,YAAIH,KAAK,GAAGC,MAAZ,EAAoB;AAClB,cAAI,KAAKb,YAAL,CAAkBgB,SAAlB,GAA8B,KAAKhB,YAAL,CAAkBe,QAApD,EAA8D;AAAA,wBACA,CAC1D,KAAKf,YAAL,CAAkBe,QADwC,EAE1D,KAAKf,YAAL,CAAkBgB,SAFwC,CADA;AAC3D,iBAAKhB,YAAL,CAAkBgB,SADyC;AAC9B,iBAAKhB,YAAL,CAAkBe,QADY;AAK7D;AACF,SAPD,MAOO,IAAI,KAAKf,YAAL,CAAkBgB,SAAlB,GAA8B,KAAKhB,YAAL,CAAkBe,QAApD,EAA8D;AAAA,sBACP,CAC1D,KAAKf,YAAL,CAAkBe,QADwC,EAE1D,KAAKf,YAAL,CAAkBgB,SAFwC,CADO;AAClE,eAAKhB,YAAL,CAAkBgB,SADgD;AACrC,eAAKhB,YAAL,CAAkBe,QADmB;AAKpE;AACF;AACF;AAED;AACF;AACA;AACA;AACA;AACA;;;;WACE,0BACEb,IADF,EAGQ;AAAA;;AAAA,UADNC,IACM,uEADmE,EACnE;AACN,UAAIwB,IAAJ;AAEA,WAAKC,eAAL,GAAuB,EAAvB;AACAV,MAAAA,UAAU,CAAC;AAAA,eAAM,MAAI,CAACW,QAAL,CAAcT,IAAd,CAAmB,MAAI,CAACQ,eAAxB,CAAN;AAAA,OAAD,CAAV;AACA,UAAME,KAAK,GAAGC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAAd;;AACAF,MAAAA,KAAK,CAACG,MAAN,GAAe,YAAM;AACnB,YAAMC,MAAM,GAAGH,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAf;AACA,YAAMG,OAAO,GAAGD,MAAM,CAACE,UAAP,CAAkB,IAAlB,CAAhB;AACA,YAAMxB,KAAN,GAAwBkB,KAAxB,CAAMlB,KAAN;AAAA,YAAaC,MAAb,GAAwBiB,KAAxB,CAAajB,MAAb;;AAEA,QAAA,MAAI,CAACwB,wBAAL,CAA8BzB,KAA9B,EAAqCC,MAArC;;AAEA,YAAI,CAAC,MAAI,CAACyB,mBAAL,CAAyB1B,KAAzB,EAAgCC,MAAhC,CAAL,EAA8C,OAP3B,CASnB;;AACA,kCAMI,MAAI,CAACb,YANT;AAAA,wDACE0B,QADF;AAAA,YACEA,QADF,sCACad,KADb;AAAA,yDAEEa,SAFF;AAAA,YAEEA,SAFF,uCAEcZ,MAFd;AAAA,yDAGEE,QAHF;AAAA,YAGEA,QAHF,uCAGaH,KAHb;AAAA,yDAIEI,SAJF;AAAA,YAIEA,SAJF,uCAIcH,MAJd;AAAA,YAKEd,QALF,uBAKEA,QALF,CAVmB,CAkBnB;;AACA,YAAMwC,SAAS,GAAGb,QAAQ,GAAGd,KAA7B;AACA,YAAM4B,SAAS,GAAGf,SAAS,GAAGZ,MAA9B;AACA,YAAM4B,MAAM,GAAG,CAACF,SAAD,EAAYC,SAAZ,EAAuBE,MAAvB,CAA8B,UAACC,KAAD;AAAA,iBAAWA,KAAK,GAAG,CAAnB;AAAA,SAA9B,CAAf;AACA,YAAIA,KAAK,GAAG,CAAZ;;AACA,YAAIF,MAAM,CAACnB,MAAP,GAAgB,CAApB,EAAuB;AACrBqB,UAAAA,KAAK,GAAG5C,QAAQ,GAAG6C,IAAI,CAACC,GAAL,OAAAD,IAAI,mCAAQH,MAAR,EAAP,GAAyBG,IAAI,CAACE,GAAL,OAAAF,IAAI,mCAAQH,MAAR,EAA7C;AACD;;AACD,YAAIM,QAAQ,GAAGnC,KAAK,GAAG+B,KAAvB;AACA,YAAIK,SAAS,GAAGnC,MAAM,GAAG8B,KAAzB,CA3BmB,CA6BnB;;AACA,YAAII,QAAQ,GAAGhC,QAAX,IAAuBiC,SAAS,GAAGhC,SAAvC,EAAkD;AAChD,cAAMiC,SAAS,GAAGlC,QAAQ,GAAGH,KAA7B;AACA,cAAMsC,SAAS,GAAGlC,SAAS,GAAGH,MAA9B;;AACA,cAAM4B,OAAM,GAAG,CAACQ,SAAD,EAAYC,SAAZ,EAAuBR,MAAvB,CAA8B,UAACC,KAAD;AAAA,mBAAWA,KAAK,GAAG,CAAnB;AAAA,WAA9B,CAAf;;AACAA,UAAAA,KAAK,GAAGF,OAAM,CAACnB,MAAP,GAAgB,CAAhB,GAAoBsB,IAAI,CAACE,GAAL,OAAAF,IAAI,mCAAQH,OAAR,EAAxB,GAA0C,CAAlD;AACAM,UAAAA,QAAQ,GAAGnC,KAAK,GAAG+B,KAAnB;AACAK,UAAAA,SAAS,GAAGnC,MAAM,GAAG8B,KAArB;AACD;;AAED,YAAIQ,WAAW,GAAGJ,QAAQ,GAAGrB,QAAX,GAAsBA,QAAQ,GAAGiB,KAAjC,GAAyC/B,KAA3D;AACA,YAAIwC,YAAY,GAAGJ,SAAS,GAAGvB,SAAZ,GAAwBA,SAAS,GAAGkB,KAApC,GAA4C9B,MAA/D;AACA,YAAIwC,CAAC,GAAG,CAAR;AACA,YAAIC,CAAC,GAAG,CAAR,CA1CmB,CA4CnB;;AACA,YAAIP,QAAQ,GAAGrB,QAAf,EAAyB;AACvB2B,UAAAA,CAAC,GAAG,CAACzC,KAAK,GAAGuC,WAAT,IAAwB,CAA5B;AACAJ,UAAAA,QAAQ,GAAGrB,QAAX;AACD,SAhDkB,CAkDnB;;;AACA,YAAIsB,SAAS,GAAGvB,SAAhB,EAA2B;AACzB6B,UAAAA,CAAC,GAAG,CAACzC,MAAM,GAAGuC,YAAV,IAA0B,CAA9B;AACAJ,UAAAA,SAAS,GAAGvB,SAAZ;AACD;;AAEDS,QAAAA,MAAM,CAACtB,KAAP,GAAemC,QAAf;AACAb,QAAAA,MAAM,CAACrB,MAAP,GAAgBmC,SAAhB;AACAb,QAAAA,OAAO,CAACoB,SAAR,CACEzB,KADF,EAEEuB,CAFF,EAGEC,CAHF,EAIEH,WAJF,EAKEC,YALF,EAME,CANF,EAOE,CAPF,EAQElB,MAAM,CAACtB,KART,EASEsB,MAAM,CAACrB,MATT;AAYA,YAAM2C,QAAyB,GAAG,CAChC;AACEhD,UAAAA,IAAI,EAAE,mBADR;AAEEiD,UAAAA,KAAK,EAAEC,MAAM,CAAC,MAAI,CAAC1D,YAAL,CAAkBJ,OAAnB;AAFf,SADgC,CAAlC;;AAOA,YAAI+B,IAAI,IAAIA,IAAI,CAACgC,GAAb,IAAoBhC,IAAI,CAACiC,GAA7B,EAAkC;AAChCJ,UAAAA,QAAQ,CAACK,IAAT,CACE;AACErD,YAAAA,IAAI,EAAE,eADR;AAEEiD,YAAAA,KAAK,EAAE9B,IAAI,CAACgC;AAFd,WADF,EAKE;AACEnD,YAAAA,IAAI,EAAE,eADR;AAEEiD,YAAAA,KAAK,EAAE9B,IAAI,CAACiC;AAFd,WALF;AAUD;;AAED,QAAA,MAAI,CAAChC,eAAL,GAAuB,EAAvB;AACAV,QAAAA,UAAU,CAAC;AAAA,iBAAM,MAAI,CAACW,QAAL,CAAcT,IAAd,CAAmB,MAAI,CAACQ,eAAxB,CAAN;AAAA,SAAD,CAAV;;AAEA,YAAMkC,YAAY,GAAG,SAAfA,YAAe,CAACvD,IAAD,EAA6B;AAChD,cAAI,CAACA,IAAL,EAAW;AACTW,YAAAA,UAAU,CAAC;AAAA,qBAAM,MAAI,CAACC,KAAL,CAAWC,IAAX,CAAgB,SAAhB,CAAN;AAAA,aAAD,CAAV;AACAF,YAAAA,UAAU,CAAC;AAAA,qBAAM,MAAI,CAACG,QAAL,CAAcD,IAAd,CAAmB,IAAnB,CAAN;AAAA,aAAD,CAAV;;AACA,YAAA,MAAI,CAAChB,KAAL;;AACA;AACD;;AAED,UAAA,MAAI,CAACwB,eAAL,GAAuB,EAAvB;AACAV,UAAAA,UAAU,CAAC;AAAA,mBAAM,MAAI,CAACW,QAAL,CAAcT,IAAd,CAAmB,MAAI,CAACQ,eAAxB,CAAN;AAAA,WAAD,CAAV,CATgD,CAWhD;;AAEA,cAAMmC,SAAS,GAAG7D,IAAI,CAACM,IAAL,CAAUwD,KAAV,CAAgB,GAAhB,CAAlB;AACAD,UAAAA,SAAS,CAACE,GAAV;AAEA,cAAMC,SAAS,8CAAOH,SAAP,IAAkBxD,IAAI,CAACG,IAAL,CAAUyD,OAAV,CAAkB,QAAlB,EAA4B,EAA5B,CAAlB,EAAf;AACA,cAAMC,OAAO,GAAG,IAAI3D,IAAJ,CAAS,CAACF,IAAD,CAAT,EAAiB2D,SAAS,CAACG,IAAV,CAAe,GAAf,CAAjB,EAAsC;AACpD3D,YAAAA,IAAI,EAAEH,IAAI,CAACG;AADyC,WAAtC,CAAhB;;AAIA,UAAA,MAAI,CAAC4D,aAAL,CAAmBF,OAAnB,YAAgCZ,QAAhC,mCAA6CrD,IAA7C;AACD,SAtBD;;AAwBA+B,QAAAA,MAAM,CAACqC,MAAP,CACET,YADF,EAEE,MAAI,CAAC9D,YAAL,CAAkBH,UAFpB,EAGE,MAAI,CAACG,YAAL,CAAkBJ,OAHpB;AAKD,OA1HD;;AA4HA,UAAM4E,MAAM,GAAG,IAAIC,UAAJ,EAAf;;AACAD,MAAAA,MAAM,CAACvC,MAAP,GAAgB,UAACyC,KAAD,EAAW;AACzB,YAAMC,MAAM,GAAGD,KAAK,CAACE,MAAN,CAAcD,MAA7B;AAEA,YAAME,UAAU,GAAG,MAAI,CAAC5E,MAAL,CAAY6E,GAAZ,IAAmB,MAAI,CAAC7E,MAAL,CAAY8E,SAAlD;;AAEA,YAAIJ,MAAM,IAAI,OAAOA,MAAP,KAAkB,QAAhC,EAA0C;AACxC,cAAI;AACF,gBAAMK,IAAI,GAAGC,gCAAkBC,MAAlB,CAAyBP,MAAzB,EAAiCQ,KAAjC,EAAb;;AACA,gBAAIH,IAAI,IAAIA,IAAI,CAACI,IAAL,CAAWC,WAAnB,IAAkCL,IAAI,CAACI,IAAL,CAAWE,YAAjD,EAA+D;AAC7D,kBAAM3B,GAAG,GAAGD,MAAM,CAACsB,IAAI,CAACI,IAAL,CAAWC,WAAZ,CAAlB;AACA,kBAAMzB,GAAG,GAAGF,MAAM,CAACsB,IAAI,CAACI,IAAL,CAAWE,YAAZ,CAAlB;AACA3D,cAAAA,IAAI,GAAG;AAAEgC,gBAAAA,GAAG,EAAHA,GAAF;AAAOC,gBAAAA,GAAG,EAAHA;AAAP,eAAP;AACD;AACF,WAPD,CAOE,OAAO2B,CAAP,EAAU;AACVC,YAAAA,OAAO,CAACC,GAAR;AACD;AACF;;AACD3D,QAAAA,KAAK,CAAC4D,GAAN,GAAYb,UAAU,CAACc,eAAX,CAA2BzF,IAA3B,CAAZ;AACD,OAlBD;;AAmBAsE,MAAAA,MAAM,CAACoB,iBAAP,CAAyB1F,IAAzB;AACD;;;WA3RD,2BAAkD;AAChD,aAAO,IAAI2F,OAAJ,CAAqB,UAACC,OAAD,EAAa;AACvC,YAAMC,GAAG,GAAG,IAAIC,KAAJ,EAAZ;;AACAD,QAAAA,GAAG,CAAC9D,MAAJ,GAAa;AAAA,iBAAM6D,OAAO,CAACC,GAAG,CAACnF,KAAJ,KAAc,CAAd,IAAmBmF,GAAG,CAAClF,MAAJ,KAAe,CAAnC,CAAb;AAAA,SAAb;;AACAkF,QAAAA,GAAG,CAACE,OAAJ,GAAc;AAAA,iBAAMH,OAAO,CAAC,KAAD,CAAb;AAAA,SAAd;;AACAC,QAAAA,GAAG,CAACL,GAAJ,GACE,yGADF;AAED,OANM,CAAP;AAOD;AAED;AACF;AACA;AACA;;;;WACE,qCAAmD;AACjD,UAAMxD,MAAM,GAAGH,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAf;AACAE,MAAAA,MAAM,CAACtB,KAAP,GAAe,CAAf;AACAsB,MAAAA,MAAM,CAACrB,MAAP,GAAgB,CAAhB;AACA,aAAOqB,MAAM,CAACgE,SAAP,CAAiB,YAAjB,EAA+BC,KAA/B,CAAqC,YAArC,MAAuD,IAA9D;AACD;;;EArF8BC,gB","sourcesContent":["import { FileUpload, FileUploadOptions, metadata } from \"./file\";\nimport { ExifParserFactory } from \"ts-exif-parser\";\n\nexport interface Window {\n  URL?: any;\n  webkitURL?: any;\n}\n\n/**\n * ImageUpload options\n * @extends FileUploadOptions\n */\nexport interface ImageUploadOptions extends FileUploadOptions {\n  /** Max width of the image. If to big, image is resized */\n  maxWidth?: number;\n\n  /** Max height of the image. If to big, image is resized */\n  maxHeight?: number;\n\n  /** Min width of the image. If to small, throw an error */\n  minWidth?: number;\n\n  /** Min height of the image. If to small, throw an error */\n  minHeight?: number;\n\n  /**\n   * If true, the max/min Width & Height are interchangeables for validation & resize.\n   * @default true\n   */\n  orientationAllowed?: boolean;\n\n  /**\n   * Image AllowedTypes Format types MIME\n   * @default ['image/jpeg', 'image/png']\n   */\n  allowedTypes?: Array<string>;\n\n  /**\n   * Image AllowedTypes Format types MIME\n   * @default 'image/jpeg' | 'image/webp'\n   */\n  outputType?: \"image/jpeg\" | \"image/webp\";\n\n  /**\n   * Compression quality of the jpeg conversion\n   * @default 0.75\n   */\n  quality?: number;\n\n  /**\n   * Resize strategy when the picture is too big (keep the ratio)\n   * False => Biggest pictures possible, max resolution but can crop a huge part of the picture\n   * True => Keep the most of the picture, min crop but can drop the quality of the picture\n   * @default true\n   */\n  lessCrop?: boolean;\n}\n\n/**\n * Class upload image, to send an image to a server with an axios request\n * @extends FileUpload\n * Documentation : Le live\n */\nexport class ImageUpload extends FileUpload {\n  imageOptions: ImageUploadOptions;\n  window: Window;\n\n  /**\n   * @param {ImageUploadOptions} options\n   */\n  constructor(options: ImageUploadOptions) {\n    const {\n      allowedTypes = [\"image/jpeg\", \"image/png\"],\n      quality = 0.75,\n      outputType = \"image/jpeg\",\n      orientationAllowed = true,\n      lessCrop = false,\n    } = options;\n\n    super(options);\n    this.imageOptions = {\n      allowedTypes,\n      quality,\n      outputType,\n      orientationAllowed,\n      lessCrop,\n      ...this.options,\n      ...options,\n    };\n    this.window = window;\n  }\n\n  /**\n   * Upload image from a file\n   * @param {File} file\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  public uploadFile(\n    file: File,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    this.reset();\n\n    if (!this.isFileTypeValid(file)) {\n      return;\n    }\n\n    this.resizeAndConvert(file, data);\n  }\n\n  /**\n   * Upload image from a blob\n   * @param {Blob} blob\n   * @param {string} name\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  public uploadBlob(\n    blob: Blob,\n    name: string,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    const file = new File([blob], name, { type: blob.type });\n    this.uploadFile(file, data);\n  }\n\n  /**\n   * Determines if webp is supported by the browser\n   * @returns a promise resolving to a boolean to know if webp is supported\n   */\n  public static isWebpSupported(): Promise<Boolean> {\n    return new Promise<Boolean>((resolve) => {\n      const img = new Image();\n      img.onload = () => resolve(img.width === 2 && img.height === 1);\n      img.onerror = () => resolve(false);\n      img.src =\n        \"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==\";\n    });\n  }\n\n  /**\n   * Determines if webp convertion with canvas is supported by the browser\n   * @returns a boolean to know if webp conversion is supported\n   */\n  public static isWebpConvertionSupported(): Boolean {\n    const canvas = document.createElement(\"canvas\");\n    canvas.width = 1;\n    canvas.height = 1;\n    return canvas.toDataURL(\"image/webp\").match(\"image/webp\") !== null;\n  }\n\n  /**\n   * Determines if image min size is valid\n   * Emit error if setError\n   * @param {number} width\n   * @param {number} height\n   * @param {boolean} setError default true\n   * @returns true if image min size valid, false otherwise\n   */\n  protected isImageMinSizeValid(\n    width: number,\n    height: number,\n    setError: boolean = true\n  ): boolean {\n    if (!(this.imageOptions.minWidth && this.imageOptions.minHeight)) {\n      return true;\n    }\n\n    const isValid =\n      width >= this.imageOptions.minWidth &&\n      height >= this.imageOptions.minHeight;\n\n    if (setError && !isValid) {\n      setTimeout(() => this.error.next(\"minsize\"));\n      setTimeout(() => this.complete.next(true));\n    }\n\n    return isValid;\n  }\n\n  /**\n   * Determines if file type is valid\n   * @param {File} file\n   * @returns {boolean} true if file type valid, false otherwise\n   */\n  protected isFileTypeValid(file: File): boolean {\n    if (\n      this.imageOptions.allowedTypes!.length > 0 &&\n      !this.imageOptions.allowedTypes!.some(\n        (allowedType) => allowedType === file.type\n      )\n    ) {\n      setTimeout(() => {\n        const error =\n          file.type === \"image/webp\"\n            ? \"invalid_filetype_webp\"\n            : \"invalid_filetype\";\n        this.error.next(error);\n      });\n      setTimeout(() => this.complete.next(true));\n      this.reset();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * If orientationAllowed, handle big side/small side instead of width/height\n   *\n   * @param {number} width\n   * @param {number} height\n   */\n  private handleOrientationAllowed(width: number, height: number) {\n    if (!this.imageOptions.orientationAllowed) return;\n\n    // handle max size. If image is wider than higher we make sur that maxWidth is bigger than maxHeight\n    // if not we swap max size\n    if (this.imageOptions.maxHeight && this.imageOptions.maxWidth) {\n      if (width > height) {\n        if (this.imageOptions.maxHeight > this.imageOptions.maxWidth) {\n          [this.imageOptions.maxHeight, this.imageOptions.maxWidth] = [\n            this.imageOptions.maxWidth,\n            this.imageOptions.maxHeight,\n          ];\n        }\n      } else if (this.imageOptions.maxHeight < this.imageOptions.maxWidth) {\n        [this.imageOptions.maxHeight, this.imageOptions.maxWidth] = [\n          this.imageOptions.maxWidth,\n          this.imageOptions.maxHeight,\n        ];\n      }\n    }\n\n    // handle min size. If image is wider than higher we make sur that minWidth is bigger than minHeight\n    // if not we swap min size\n    if (this.imageOptions.minHeight && this.imageOptions.minWidth) {\n      if (width > height) {\n        if (this.imageOptions.minHeight > this.imageOptions.minWidth) {\n          [this.imageOptions.minHeight, this.imageOptions.minWidth] = [\n            this.imageOptions.minWidth,\n            this.imageOptions.minHeight,\n          ];\n        }\n      } else if (this.imageOptions.minHeight < this.imageOptions.minWidth) {\n        [this.imageOptions.minHeight, this.imageOptions.minWidth] = [\n          this.imageOptions.minWidth,\n          this.imageOptions.minHeight,\n        ];\n      }\n    }\n  }\n\n  /**\n   * Build FormData et call sendFiles\n   * Gère les erreurs\n   * @param {File} file\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  private resizeAndConvert(\n    file: File,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    let exif: any;\n\n    this.initialProgress = 10;\n    setTimeout(() => this.progress.next(this.initialProgress));\n    const image = document.createElement(\"img\");\n    image.onload = () => {\n      const canvas = document.createElement(\"canvas\");\n      const context = canvas.getContext(\"2d\")!;\n      let { width, height } = image;\n\n      this.handleOrientationAllowed(width, height);\n\n      if (!this.isImageMinSizeValid(width, height)) return;\n\n      // if no max/min size, set max/min size to width/height\n      const {\n        maxWidth = width,\n        maxHeight = height,\n        minWidth = width,\n        minHeight = height,\n        lessCrop,\n      } = this.imageOptions;\n\n      // Define ratio to have the biggest image allowed\n      const maxWRatio = maxWidth / width;\n      const maxHRatio = maxHeight / height;\n      const ratios = [maxWRatio, maxHRatio].filter((ratio) => ratio < 1);\n      let ratio = 1;\n      if (ratios.length > 0) {\n        ratio = lessCrop ? Math.min(...ratios) : Math.max(...ratios);\n      }\n      let newWidth = width * ratio;\n      let newHeight = height * ratio;\n\n      // Make sure the ratio respect min size if we need to resize down the image\n      if (newWidth < minWidth || newHeight < minHeight) {\n        const minWRatio = minWidth / width;\n        const minHRatio = minHeight / height;\n        const ratios = [minWRatio, minHRatio].filter((ratio) => ratio < 1);\n        ratio = ratios.length > 0 ? Math.max(...ratios) : 1;\n        newWidth = width * ratio;\n        newHeight = height * ratio;\n      }\n\n      let sourceWidth = newWidth > maxWidth ? maxWidth / ratio : width;\n      let sourceHeight = newHeight > maxHeight ? maxHeight / ratio : height;\n      let x = 0;\n      let y = 0;\n\n      // if needed, offset the exceeding part on the x axis\n      if (newWidth > maxWidth) {\n        x = (width - sourceWidth) / 2;\n        newWidth = maxWidth;\n      }\n\n      // if needed, offset the exceeding part on the y axis\n      if (newHeight > maxHeight) {\n        y = (height - sourceHeight) / 2;\n        newHeight = maxHeight;\n      }\n\n      canvas.width = newWidth;\n      canvas.height = newHeight;\n      context.drawImage(\n        image,\n        x,\n        y,\n        sourceWidth,\n        sourceHeight,\n        0,\n        0,\n        canvas.width,\n        canvas.height\n      );\n\n      const metadata: Array<metadata> = [\n        {\n          name: \"metadata[quality]\",\n          value: String(this.imageOptions.quality),\n        },\n      ];\n\n      if (exif && exif.lat && exif.lon) {\n        metadata.push(\n          {\n            name: \"metadata[lat]\",\n            value: exif.lat,\n          },\n          {\n            name: \"metadata[lon]\",\n            value: exif.lon,\n          }\n        );\n      }\n\n      this.initialProgress = 17;\n      setTimeout(() => this.progress.next(this.initialProgress));\n\n      const blobCallback = (blob: Blob | null): void => {\n        if (!blob) {\n          setTimeout(() => this.error.next(\"default\"));\n          setTimeout(() => this.complete.next(true));\n          this.reset();\n          return;\n        }\n\n        this.initialProgress = 25;\n        setTimeout(() => this.progress.next(this.initialProgress));\n\n        // Rename file with correct extension\n\n        const nameSplit = file.name.split(\".\");\n        nameSplit.pop();\n\n        const nameParts = [...nameSplit, blob.type.replace(\"image/\", \"\")];\n        const newFile = new File([blob], nameParts.join(\".\"), {\n          type: blob.type,\n        });\n\n        this.buildFormData(newFile, [...metadata, ...data]);\n      };\n\n      canvas.toBlob(\n        blobCallback,\n        this.imageOptions.outputType,\n        this.imageOptions.quality\n      );\n    };\n\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const result = event.target!.result;\n\n      const urlCreator = this.window.URL || this.window.webkitURL;\n\n      if (result && typeof result !== \"string\") {\n        try {\n          const Data = ExifParserFactory.create(result).parse();\n          if (Data && Data.tags!.GPSLatitude && Data.tags!.GPSLongitude) {\n            const lat = String(Data.tags!.GPSLatitude);\n            const lon = String(Data.tags!.GPSLongitude);\n            exif = { lat, lon };\n          }\n        } catch (e) {\n          console.log(`can't read exif data`);\n        }\n      }\n      image.src = urlCreator.createObjectURL(file);\n    };\n    reader.readAsArrayBuffer(file);\n  }\n}\n"],"file":"image.js"}